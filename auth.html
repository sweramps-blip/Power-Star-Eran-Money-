<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Power Star | Secure Auth</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; font-family: 'Outfit', sans-serif; background: #0a0e1a; color: #fff; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
body::before { content: ''; position: fixed; top: -40%; left: 50%; transform: translateX(-50%); width: 600px; height: 600px; background: radial-gradient(circle, rgba(251,191,36,0.12) 0%, transparent 70%); pointer-events: none; z-index: 0; }
.page { min-height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 16px; position: relative; z-index: 1; }
.logo-wrap { text-align: center; margin-bottom: 28px; }
.logo-icon { width: 64px; height: 64px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 28px; color: #0a0e1a; box-shadow: 0 6px 24px rgba(251,191,36,0.35); margin-bottom: 14px; }
.logo-wrap h1 { font-size: 24px; font-weight: 800; color: #fff; letter-spacing: 1.5px; text-transform: uppercase; }
.logo-wrap p { font-size: 12px; color: #64748b; margin-top: 3px; letter-spacing: 0.5px; }
.card { width: 100%; max-width: 380px; background: #131829; border: 1px solid #1e2a45; border-radius: 24px; padding: 28px 22px 24px; position: relative; box-shadow: 0 12px 48px rgba(0,0,0,0.35); }
.tab-bar { display: flex; background: #0a0e1a; border-radius: 14px; padding: 4px; margin-bottom: 28px; gap: 4px; }
.tab-btn { flex: 1; padding: 10px 0; border: none; background: transparent; color: #64748b; font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600; border-radius: 11px; cursor: pointer; transition: all 0.3s ease; position: relative; z-index: 1; }
.tab-btn.active { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0a0e1a; box-shadow: 0 3px 12px rgba(251,191,36,0.3); }
.form-panel { display: none; animation: fadeUp 0.35s ease; }
.form-panel.active { display: block; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.field { position: relative; margin-bottom: 16px; }
.field label { display: block; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 7px; padding-left: 2px; }
.input-wrap { position: relative; }
.input-wrap input { width: 100%; padding: 13px 14px; padding-left: 42px; background: #0f1423; border: 1.5px solid #1e2a45; border-radius: 13px; color: #fff; font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 500; outline: none; transition: border-color 0.25s, box-shadow 0.25s; -webkit-appearance: none; }
.input-wrap input::placeholder { color: #3d4f6e; font-weight: 400; }
.input-wrap input:focus { border-color: #fbbf24; box-shadow: 0 0 0 3px rgba(251,191,36,0.15); }
.input-icon { position: absolute; left: 13px; top: 50%; transform: translateY(-50%); color: #3d4f6e; font-size: 14px; pointer-events: none; transition: color 0.25s; }
.input-wrap:focus-within .input-icon { color: #fbbf24; }
.eye-toggle { position: absolute; right: 13px; top: 50%; transform: translateY(-50%); color: #3d4f6e; font-size: 14px; cursor: pointer; transition: color 0.25s; background: none; border: none; padding: 4px; z-index: 2; }
.eye-toggle:hover { color: #fbbf24; }
.phone-prefix { position: absolute; left: 38px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: 600; color: #fbbf24; pointer-events: none; z-index: 1; }
.input-wrap.phone input { padding-left: 78px; }
.strength-track { display: flex; gap: 5px; margin-top: 8px; height: 3px; }
.strength-seg { flex: 1; border-radius: 3px; background: #1e2a45; transition: background 0.3s; }
.strength-seg.on-weak { background: #ef4444; }
.strength-seg.on-medium { background: #f97316; }
.strength-seg.on-strong { background: #22c55e; }
.strength-label { font-size: 10px; font-weight: 600; margin-top: 5px; }
.terms-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 22px; }
.terms-row input[type="checkbox"] { width: 16px; height: 16px; border-radius: 4px; border: 1.5px solid #1e2a45; cursor: pointer; flex-shrink: 0; margin-top: 2px; }
.terms-row label { font-size: 11px; color: #64748b; line-height: 1.5; cursor: pointer; }
.terms-row .highlight { color: #fbbf24; font-weight: 600; }
.submit-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0a0e1a; border: none; border-radius: 13px; font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; cursor: pointer; box-shadow: 0 4px 15px rgba(251,191,36,0.3); transition: transform 0.2s, box-shadow 0.2s; }
.submit-btn:active { transform: scale(0.97); box-shadow: 0 2px 8px rgba(251,191,36,0.2); }
.device-row { margin-top: 20px; font-size: 10px; color: #3d4f6e; display: flex; align-items: center; gap: 6px; justify-content: center; }
.did-value { font-family: 'Courier New', monospace; color: #64748b; font-weight: 600; letter-spacing: 1px; }
.did-eye { cursor: pointer; transition: color 0.25s; }
.did-eye:hover { color: #fbbf24; }
</style>

</head>
<body>

<div class="page">
  <div class="logo-wrap">
    <div class="logo-icon">â­</div>
    <h1>Power Star</h1>
    <p>Secure Access Portal</p>
  </div>

  <div class="card">
    <div class="tab-bar">
      <button class="tab-btn active" id="tab-login" onclick="switchTab('login')">Login</button>
      <button class="tab-btn" id="tab-register" onclick="switchTab('register')">Register</button>
    </div>

    <!-- LOGIN PANEL -->
    <div class="form-panel active" id="panel-login">
      <div class="field">
        <label>Phone Number</label>
        <div class="input-wrap phone">
          <i class="fas fa-phone input-icon"></i>
          <span class="phone-prefix">+92</span>
          <input type="tel" id="l-num" placeholder="3001234567" inputmode="numeric">
        </div>
      </div>

      <div class="field">
        <label>Password</label>
        <div class="input-wrap">
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="l-pass" placeholder="Enter password">
          <button class="eye-toggle" onclick="toggleEye('l-pass', this)">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <button class="submit-btn" onclick="doLogin()">Login</button>
    </div>

    <!-- REGISTER PANEL -->
    <div class="form-panel" id="panel-register">
      <div class="field">
        <label>Full Name</label>
        <div class="input-wrap">
          <i class="fas fa-user input-icon"></i>
          <input type="text" id="r-name" placeholder="Your full name">
        </div>
      </div>

      <div class="field">
        <label>Phone Number</label>
        <div class="input-wrap phone">
          <i class="fas fa-phone input-icon"></i>
          <span class="phone-prefix">+92</span>
          <input type="tel" id="r-num" placeholder="3001234567" inputmode="numeric">
        </div>
      </div>

      <div class="field">
        <label>Password</label>
        <div class="input-wrap">
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="r-pass" placeholder="Create password" oninput="checkStrength()">
          <button class="eye-toggle" onclick="toggleEye('r-pass', this)">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="strength-track">
          <div class="strength-seg" id="seg1"></div>
          <div class="strength-seg" id="seg2"></div>
          <div class="strength-seg" id="seg3"></div>
        </div>
        <div class="strength-label" id="strength-label"></div>
      </div>

      <div class="field">
        <label>Referral Code <span style="color:#3d4f6e;font-weight:400">(optional)</span></label>
        <div class="input-wrap">
          <i class="fas fa-tag input-icon"></i>
          <input type="text" id="r-ref" placeholder="Enter referral code">
        </div>
      </div>

      <div class="terms-row">
        <input type="checkbox" id="terms-chk">
        <label for="terms-chk">
          I accept the <span class="highlight">Terms &amp; Conditions</span> and <span class="highlight">Privacy Policy</span>
        </label>
      </div>

      <button class="submit-btn" onclick="doRegister()">Create Account</button>
    </div>

    <div class="device-row">
      <i class="fas fa-shield-halved"></i>
      Device ID:
      <span class="did-value" id="did-text">######</span>
      <i class="fas fa-eye did-eye" id="did-eye-icon" onclick="toggleDID()"></i>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš ï¸âš ï¸âš ï¸ IMPORTANT - SET YOUR API URL HERE âš ï¸âš ï¸âš ï¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// After deploying the Google Apps Script, paste the Web App URL below
// Example: "https://script.google.com/macros/s/AKfycbxxxxx.../exec"

const API = "PASTE_YOUR_DEPLOYED_SCRIPT_URL_HERE";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KEY = "POWER_STAR_786_SECURE";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEVICE ID GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const current_device_id = btoa(
  navigator.userAgent + 
  screen.width + 
  screen.height +
  Intl.DateTimeFormat().resolvedOptions().timeZone +
  (navigator.hardwareConcurrency || 0) +
  (navigator.deviceMemory || 0)
).substring(0, 32);

document.getElementById("did-text").innerText = current_device_id.slice(0, 6) + "****";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.getElementById("tab-login").classList.toggle("active", tab === "login");
  document.getElementById("tab-register").classList.toggle("active", tab === "register");
  document.getElementById("panel-login").classList.toggle("active", tab === "login");
  document.getElementById("panel-register").classList.toggle("active", tab === "register");
}

function toggleEye(inputId, btn) {
  const input = document.getElementById(inputId);
  const icon = btn.querySelector("i");
  if (input.type === "password") {
    input.type = "text";
    icon.classList.remove("fa-eye");
    icon.classList.add("fa-eye-slash");
  } else {
    input.type = "password";
    icon.classList.remove("fa-eye-slash");
    icon.classList.add("fa-eye");
  }
}

function toggleDID() {
  const didText = document.getElementById("did-text");
  const eyeIcon = document.getElementById("did-eye-icon");
  if (didText.innerText.includes("****")) {
    didText.innerText = current_device_id;
    eyeIcon.classList.remove("fa-eye");
    eyeIcon.classList.add("fa-eye-slash");
  } else {
    didText.innerText = current_device_id.slice(0, 6) + "****";
    eyeIcon.classList.remove("fa-eye-slash");
    eyeIcon.classList.add("fa-eye");
  }
}

function checkStrength() {
  const pass = document.getElementById("r-pass").value;
  const seg1 = document.getElementById("seg1");
  const seg2 = document.getElementById("seg2");
  const seg3 = document.getElementById("seg3");
  const label = document.getElementById("strength-label");
  
  seg1.className = "strength-seg";
  seg2.className = "strength-seg";
  seg3.className = "strength-seg";
  label.textContent = "";
  
  if (pass.length === 0) return;
  
  if (pass.length >= 6 && pass.length < 8) {
    seg1.classList.add("on-weak");
    label.textContent = "Weak";
    label.style.color = "#ef4444";
  } else if (pass.length >= 8 && pass.length < 12) {
    seg1.classList.add("on-medium");
    seg2.classList.add("on-medium");
    label.textContent = "Medium";
    label.style.color = "#f97316";
  } else if (pass.length >= 12) {
    seg1.classList.add("on-strong");
    seg2.classList.add("on-strong");
    seg3.classList.add("on-strong");
    label.textContent = "Strong";
    label.style.color = "#22c55e";
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN FUNCTION - PRODUCTION VERSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  // Check if API URL is set
  if (API === "PASTE_YOUR_DEPLOYED_SCRIPT_URL_HERE") {
    return Swal.fire({
      icon: "error",
      title: "Setup Required",
      html: "âš ï¸ Please deploy the Google Apps Script first and paste the URL in line 177 of this HTML file.",
      confirmButtonText: "OK"
    });
  }

  const num = document.getElementById("l-num").value.trim();
  const pass = document.getElementById("l-pass").value;

  if (!num || !pass) {
    return Swal.fire({ 
      icon: "warning", 
      title: "Empty Fields", 
      text: "Please enter both number and password." 
    });
  }

  if (num.length < 10) {
    return Swal.fire({ 
      icon: "warning", 
      title: "Invalid Number", 
      text: "Enter a valid phone number." 
    });
  }

  Swal.fire({
    title: 'Logging in...',
    html: 'Please wait',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const response = await fetch(API);
    const users = await response.json();
    
    console.log("ğŸ“Š Total records:", users.length);
    
    // Find user - only check REGISTRATION rows
    const user = users.find(u => {
      const isRegistration = !u.row_type || u.row_type === "REGISTRATION";
      const numberMatch = String(u.number || "").trim() === num;
      return isRegistration && numberMatch;
    });

    if (!user) {
      console.log("âŒ User not found");
      return Swal.fire({ 
        icon: "error", 
        title: "User Not Found", 
        text: "This number is not registered. Please register first.",
        confirmButtonText: "Register Now"
      }).then(() => switchTab('register'));
    }

    // Password check
    const storedPassword = String(user.password || "").trim();
    const enteredPassword = String(pass).trim();
    
    console.log("ğŸ” Password check:", {
      stored: storedPassword,
      entered: enteredPassword,
      match: storedPassword === enteredPassword
    });

    if (storedPassword !== enteredPassword) {
      return Swal.fire({ 
        icon: "error", 
        title: "Wrong Password", 
        text: "The password you entered is incorrect." 
      });
    }

    // Status check
    if (user.status === "blocked") {
      return Swal.fire({ 
        icon: "error", 
        title: "Account Blocked", 
        text: "Your account has been suspended. Contact admin." 
      });
    }

    // Success - Save to localStorage
    localStorage.setItem("power_star_user", JSON.stringify(user));
    
    Swal.fire({ 
      icon: "success", 
      title: "Welcome Back!", 
      text: `Hi ${user.name}`,
      timer: 1500,
      showConfirmButton: false
    }).then(() => {
      window.location.href = "dashboard.html";
    });

  } catch (e) {
    console.error("âŒ Error:", e);
    return Swal.fire({ 
      icon: "error", 
      title: "Connection Error", 
      text: "Could not connect to server. Check your internet or API URL." 
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REGISTER FUNCTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doRegister() {
  if (API === "https://script.google.com/macros/s/AKfycbzrAusNW6ytPi4LvVn9XWbXnmBspGj-lkVBGgGOJXQIC-GE6SNJSAGrEW9lYV7rO8cj/exec") {
    return Swal.fire({
      icon: "error",
      title: "Setup Required",
      html: "âš ï¸ Please deploy the Google Apps Script first.",
      confirmButtonText: "OK"
    });
  }

  const name = document.getElementById("r-name").value.trim();
  const num = document.getElementById("r-num").value.trim();
  const pass = document.getElementById("r-pass").value.trim();
  const ref = document.getElementById("r-ref").value.trim().toUpperCase();
  const terms = document.getElementById("terms-chk").checked;

  if (!name || !num || !pass) {
    return Swal.fire({ 
      icon: "warning", 
      title: "Empty Fields", 
      text: "Please fill all required fields." 
    });
  }

  if (num.length < 10 || num.length > 11) {
    return Swal.fire({ 
      icon: "warning", 
      title: "Invalid Number", 
      text: "Enter a valid 10-digit number (without +92)." 
    });
  }

  if (pass.length < 6) {
    return Swal.fire({ 
      icon: "warning", 
      title: "Weak Password", 
      text: "Password must be at least 6 characters." 
    });
  }

  if (!terms) {
    return Swal.fire({ 
      icon: "info", 
      title: "Terms Required", 
      text: "Please accept Terms & Conditions." 
    });
  }

  Swal.fire({
    title: 'Creating Account...',
    html: 'Please wait',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const response = await fetch(API);
    const users = await response.json();

    // Check duplicates
    const existingUser = users.find(u => 
      String(u.number || "").trim() === num && 
      (!u.row_type || u.row_type === "REGISTRATION")
    );
    
    if (existingUser) {
      return Swal.fire({ 
        icon: "error", 
        title: "Already Registered", 
        text: "This number is already in use.",
        confirmButtonText: "Go to Login"
      }).then(() => switchTab('login'));
    }

    const deviceUsed = users.find(u => 
      u.device_id === current_device_id && 
      u.device_id !== "" &&
      (!u.row_type || u.row_type === "REGISTRATION")
    );
    
    if (deviceUsed) {
      return Swal.fire({ 
        icon: "error", 
        title: "Device Already Registered", 
        html: `This device is linked to: ${deviceUsed.user_id}`,
        confirmButtonText: "OK"
      });
    }

    // Register
    const payload = {
      key: KEY,
      action: "REGISTER",
      name: name,
      number: num,
      password: pass,
      referral: ref,
      device_id: current_device_id
    };

    await fetch(API, { 
      method: "POST", 
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload) 
    });

    await new Promise(resolve => setTimeout(resolve, 2000));

    Swal.fire({ 
      icon: "success", 
      title: "Account Created!", 
      html: "Welcome to Power Star!<br>You can now login.",
      confirmButtonText: "Login Now"
    }).then(() => {
      document.getElementById("r-name").value = "";
      document.getElementById("r-num").value = "";
      document.getElementById("r-pass").value = "";
      document.getElementById("r-ref").value = "";
      document.getElementById("terms-chk").checked = false;
      checkStrength();
      switchTab("login");
      document.getElementById("l-num").value = num;
    });

  } catch (e) {
    return Swal.fire({ 
      icon: "error", 
      title: "Registration Failed", 
      text: "Something went wrong. Try again." 
    });
  }
}

// Auto-fill referral from URL
window.onload = function() {
  const urlParams = new URLSearchParams(window.location.search);
  const refCode = urlParams.get('ref');
  if (refCode) {
    document.getElementById('r-ref').value = refCode.toUpperCase();
    switchTab('register');
  }
};
</script>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

</body>
</html>
